<!DOCTYPE html>
<html lang="zh">

  <head>
    <meta charset="UTF-8" />
    <title>amis demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

    <link rel="stylesheet" title="default" href="https://unpkg.com/amis@beta/sdk/sdk.css" />
    <link rel="stylesheet" href="https://unpkg.com/amis@beta/sdk/helper.css" />
    <!-- 这是默认主题所需的，如果是其他主题则不需要 -->
    <!-- 从 1.1.0 开始 sdk.css 将不支持 IE 11，如果要支持 IE11 请引用这个 css，并把前面那个删了 -->
    <!-- <link rel="stylesheet" href="sdk-ie11.css" /> -->
    <!-- 不过 amis 开发团队几乎没测试过 IE 11 下的效果，所以可能有细节功能用不了，如果发现请报 issue -->
    <style>
      html,
      body,
      .app-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

    </style>
    <script src="https://unpkg.com/amis@beta/sdk/sdk.js"></script>
    <script src="https://unpkg.com/vue@2"></script>
    <script src="https://unpkg.com/history@4.10.1/umd/history.js"></script>
  </head>

  <body>
    <div id="root" class="app-wrapper"></div>
    <script>
      (function() {
        let amis = amisRequire('amis/embed');
        const match = amisRequire('path-to-regexp').match;

        // 如果想用 browserHistory 请切换下这处代码, 其他不用变
        // const history = History.createBrowserHistory();
        const history = History.createHashHistory();

        const app = {
          type: 'app',
          brandName: 'Admin',
          header: {
            type: 'tpl',
            inline: false,
            className: 'w-full',
            tpl: '<div class="flex justify-between"><div>顶部区域左侧</div><div>顶部区域右侧</div></div>'
          },
          footer: '<div class="p-2 text-center bg-light">底部区域</div>',
          pages: [
            {
              children: [
                {
                  label: '首页',
                  url: '/',
                  schemaApi: "get:/pages/index.json"
                }
              ]
            },
            {
              children: [
                {
                  label: '会员管理',
                  url: '/member',
                  schema: {
                    type: 'page',
                    title: '会员列表',
                    "toolbar": [
                      {
                        "type": "button",
                        "actionType": "link",
                        "link": "/crud/new",
                        "label": "新增",
                        "primary": true
                      }
                    ],
                    body: {
                      type: 'crud',
                      name: 'member',
                      api: {
                        url: 'https://api-yingyu.zoulaizouqu.cn/admin/models/User',
                        method: 'get',
                        headers: {
                          Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NDk4MTYzNjYsInVpZCI6MX0.9WMcRaOq9RbZSj24_no_eLJBw2ga4zKjZCWI5htV9D0'
                        },
                        data: {
                          _p_nickname__like: '${nickname}',
                          page: '${page}'
                        },
                        adaptor: function(payload, response) {
                          console.log(payload)
                          var data = {
                            items: payload.list,
                            total: payload.total
                          }
                          return { data: data, msg: '', status: payload.status == "succ" ? 0 : 1 }
                        }
                      },

                      'perPage': 20,
                      "filterTogglable": true, "autoGenerateFilter": true,
                      columns: [
                        {
                          label: 'ID',
                          name: 'id',
                          type: 'text',
                          searchable: {
                            "type": "input-text",
                            "name": "id",
                            "label": "主键",
                            "placeholder": "输入id"
                          }
                        },
                        {
                          label: '用户名',
                          name: 'nickname',
                          type: 'text',
                          copyable: true,
                          searchable: {
                            "type": "input-text",
                            "name": "nickname",
                            "placeholder": "输入用户名"
                          }
                        },
                        {
                          name: 'mobile',
                          label: '手机号',
                          type: 'text',
                          "quickEdit": true,
                          "copyable": true
                        },
                        {
                          name: 'refer_rate',
                          label: '推荐比例',
                          type: 'tpl',
                          tpl: '<span>${refer_rate*100}%</span>'
                        },
                        {
                          label: '创建时间',
                          name: 'created_at',
                          type: 'date',
                          "format": "YYYY年MM月DD日 HH时mm分ss秒"
                        },
                        {
                          type: 'operation',
                          label: '操作',
                          width: '150px',
                          "fixed": "right",
                          buttons: [
                            {
                              label: '删除',
                              type: 'button',
                              actionType: 'ajax',
                              level: 'danger',
                              confirmText: '确定删除吗？',
                              api: 'delete:/admiels/User/${id}',
                            },
                            {
                              label: '修改信息',
                              type: 'button',
                              actionType: 'dialog',
                              dialog: {
                                title: '修改信息',
                                body: {
                                  type: 'form',
                                  api: "post:/admin/User/${id}",
                                  data: {
                                    guide_type: '${!((newbie & 512) == 512)}'
                                  },
                                  body: [
                                    {
                                      type: 'radios',
                                      label: '导游身份:',
                                      name: 'guide_type',
                                      options: [
                                        {
                                          label: '导游',
                                          value: true
                                        },
                                        {
                                          label: '非导游',
                                          value: false
                                        }
                                      ]
                                    },
                                    {
                                      type: 'input-text',
                                      name: 'nickname',
                                      label: '用户名:',
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      ],
                      "affixHeader": true,
                      "columnsTogglable": "auto",
                      "placeholder": "暂无数据",
                      "tableClassName": "table-db table-striped",
                      "headerClassName": "crud-table-header",
                      "footerClassName": "crud-table-footer",
                      "toolbarClassName": "crud-table-toolbar",
                      "combineNum": 0,
                      "bodyClassName": "panel-default"
                    }
                  }
                }
              ]
            },
            {
              children: [
                {
                  label: '商城管理',
                  url: '/shop',
                  children: [
                    {
                      label: '商家管理',
                      url: '/shop/seller',
                      schema: {
                        type: 'page',
                        body: {
                          type: 'tpl',
                          tpl: '<div class="p-2">这里是商家管理</div>'
                        }
                      }
                    },
                    {
                      label: '店铺管理',
                      url: '/shop/shop',
                      schema: {
                        type: 'page',
                        body: {
                          type: 'tpl',
                          tpl: '<div class="p-2">这里是店铺管理</div>'
                        }
                      }
                    },
                    {
                      label: '商品分类',
                      url: '/shop/category',
                      schema: {
                        type: 'page',
                        body: {
                          type: 'tpl',
                          tpl: '<div class="p-2">这里是商品分类</div>'
                        }
                      }
                    },
                    {
                      label: '商品管理',
                      url: '/shop/goods',
                      schema: {
                        type: 'page',
                        body: {
                          type: 'tpl',
                          tpl: '<div class="p-2">这里是商品管理234234sss</div>'
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        };

        function normalizeLink(to, location = history.location) {
          to = to || '';

          if (to && to[0] === '#') {
            to = location.pathname + location.search + to;
          } else if (to && to[0] === '?') {
            to = location.pathname + to;
          }

          const idx = to.indexOf('?');
          const idx2 = to.indexOf('#');
          let pathname = ~idx
            ? to.substring(0, idx)
            : ~idx2
              ? to.substring(0, idx2)
              : to;
          let search = ~idx ? to.substring(idx, ~idx2 ? idx2 : undefined) : '';
          let hash = ~idx2 ? to.substring(idx2) : location.hash;

          if (!pathname) {
            pathname = location.pathname;
          } else if (pathname[0] != '/' && !/^https?\:\/\//.test(pathname)) {
            let relativeBase = location.pathname;
            const paths = relativeBase.split('/');
            paths.pop();
            let m;
            while ((m = /^\.\.?\//.exec(pathname))) {
              if (m[0] === '../') {
                paths.pop();
              }
              pathname = pathname.substring(m[0].length);
            }
            pathname = paths.concat(pathname).join('/');
          }

          return pathname + search + hash;
        }

        function isCurrentUrl(to, ctx) {
          if (!to) {
            return false;
          }
          const pathname = history.location.pathname;
          const link = normalizeLink(to, {
            ...location,
            pathname,
            hash: ''
          });

          if (!~link.indexOf('http') && ~link.indexOf(':')) {
            let strict = ctx && ctx.strict;
            return match(link, {
              decode: decodeURIComponent,
              strict: typeof strict !== 'undefined' ? strict : true
            })(pathname);
          }

          return decodeURI(pathname) === link;
        }

        let amisInstance = amis.embed(
          '#root',
          app,
          {
            location: history.location
          },
          {
            // watchRouteChange: fn => {
            //   return history.listen(fn);
            // },
            updateLocation: (location, replace) => {
              location = normalizeLink(location);
              if (location === 'goBack') {
                return history.goBack();
              } else if (
                (!/^https?\:\/\//.test(location) &&
                  location ===
                  history.location.pathname + history.location.search) ||
                location === history.location.href
              ) {
                // 目标地址和当前地址一样，不处理，免得重复刷新
                return;
              } else if (/^https?\:\/\//.test(location) || !history) {
                return (window.location.href = location);
              }

              history[replace ? 'replace' : 'push'](location);
            },
            jumpTo: (to, action) => {
              if (to === 'goBack') {
                return history.goBack();
              }

              to = normalizeLink(to);

              if (isCurrentUrl(to)) {
                return;
              }

              if (action && action.actionType === 'url') {
                action.blank === false
                  ? (window.location.href = to)
                  : window.open(to, '_blank');
                return;
              } else if (action && action.blank) {
                window.open(to, '_blank');
                return;
              }

              if (/^https?:\/\//.test(to)) {
                window.location.href = to;
              } else if (
                (!/^https?\:\/\//.test(to) &&
                  to === history.pathname + history.location.search) ||
                to === history.location.href
              ) {
                // do nothing
              } else {
                history.push(to);
              }
            },
            isCurrentUrl: isCurrentUrl,
            theme: 'cxd'
          }
        );

        history.listen(state => {
          amisInstance.updateProps({
            location: state.location || state
          });
        });
      })();
    </script>
  </body>

</html>
